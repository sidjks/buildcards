<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Selection App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for smoother transitions and consistent font */
        body {
            font-family: 'Inter', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ensure pre tags respect whitespace but wrap if needed */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Hide scrollbar for pre-formatted content if it overflows, but allow content to wrap */
        .overflow-auto {
            overflow: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-white via-blue-50 to-blue-100 flex flex-col items-center justify-center p-4 font-sans">

    <div id="app-container" class="w-full">
        <!-- Main Heading (dynamic) -->
        <h1 id="main-heading" class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-10 text-center leading-tight">
            Please Select one of the Menu Items:
        </h1>

        <!-- Random Blind Recite Button (moved outside detail-view) -->
        <div class="flex justify-center mb-8" id="random-blind-recite-button-container">
            <button id="random-blind-recite-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Random Blind Recite
            </button>
        </div>

        <!-- Initial Menu Cards View -->
        <div id="menu-cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Menu cards will be injected here by JavaScript -->
        </div>

        <!-- Selected Item Detail View (initially hidden) -->
        <div id="detail-view" class="hidden w-full bg-white rounded-3xl shadow-xl p-8 md:p-10 flex flex-col items-center relative transform transition-all duration-300 ease-in-out scale-95 md:scale-100">
            <!-- Back Arrow Button -->
            <button id="back-button" class="absolute top-6 left-6 p-3 rounded-full bg-gray-100 hover:bg-gray-200 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300 shadow-md" aria-label="Back to Menu">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </button>

            <!-- Action buttons -->
            <div class="flex flex-wrap justify-center gap-4 mb-8 mt-12"> <!-- Added mt-12 to compensate for main heading -->
                <button id="view-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                    View
                </button>
                <button id="copy-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                    Copy
                </button>
                <button id="recite-button" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75">
                    Recite
                </button>
                <button id="blind-recite-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                    Blind Recite
                </button>
            </div>

            <!-- Message display -->
            <pre id="message-display" class="hidden text-base text-gray-700 mt-6 text-left whitespace-pre-wrap bg-gray-50 p-4 rounded-lg shadow-inner w-full max-w-xl mx-auto animate-fade-in"></pre>

            <!-- Copy Sections (side-by-side, initially hidden) -->
            <div id="copy-sections" class="hidden w-full mt-8 p-6 bg-gray-50 rounded-2xl shadow-inner flex flex-col md:flex-row md:space-x-6 items-stretch">
                <!-- Section 1: What the View does -->
                <div class="mb-6 md:mb-0 p-5 bg-white rounded-xl border border-gray-200 w-full md:w-1/2 flex flex-col shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-3">View Content:</h3>
                    <pre id="copy-view-content" class="text-base text-gray-700 whitespace-pre-wrap font-sans flex-grow overflow-auto p-2 bg-gray-100 rounded-lg"></pre>
                </div>

                <!-- Section 2: Type and Copy -->
                <div class="p-5 bg-white rounded-xl border border-gray-200 w-full md:w-1/2 flex flex-col shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-3">Type and Copy:</h3>
                    <textarea id="copy-input-text" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 font-sans resize-none flex-grow text-base shadow-sm" placeholder="Type text to copy here..."></textarea>
                </div>
            </div>
            <!-- Copy Typed Text button (initially hidden) -->
            <button id="copy-typed-button" class="hidden mt-6 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-opacity-75">
                Correct Text
            </button>

            <!-- Recite Section (only input box, initially hidden) -->
            <div id="recite-section" class="hidden w-full mt-8 p-6 bg-white rounded-2xl shadow-inner flex flex-col items-center">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Recite Content:</h3>
                <textarea id="recite-input-text" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 font-sans resize-none text-base shadow-sm" rows="8" placeholder="Type the content here..."></textarea>
                <button id="recite-typed-button" class="mt-4 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:ring-opacity-75">
                    Recite Text
                </button>
            </div>

            <!-- Blind Recite Section (initially hidden) -->
            <div id="blind-recite-section" class="hidden w-full mt-8 p-6 bg-white rounded-2xl shadow-inner flex flex-col items-center">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3" id="blind-recite-heading">Your Turn:</h3>
                <pre id="blind-recite-current-line" class="hidden text-base text-gray-700 whitespace-pre-wrap font-sans p-2 bg-gray-100 rounded-lg w-full mb-4 text-center"></pre>
                <textarea id="blind-recite-input-text" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 font-sans resize-none text-base shadow-sm" rows="3" placeholder="Type the line here..."></textarea>
                <p id="blind-recite-feedback" class="text-lg font-semibold mb-4"></p>
                <button id="blind-recite-next-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                    Next Line
                </button>
                <p id="blind-recite-summary" class="text-lg font-bold mt-4"></p>
                <button id="blind-recite-reset-button" class="hidden mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                    Reset Blind Recite
                </button>
            </div>
        </div>

        <!-- Random Blind Recite Section (new, now a sibling to detail-view) -->
        <div id="random-blind-recite-section" class="hidden w-full mt-8 p-6 bg-white rounded-2xl shadow-inner flex flex-col items-center">
            <h3 class="text-2xl font-semibold text-gray-800 mb-3" id="random-blind-recite-heading">Recite: <span id="random-blind-recite-item-name" class="font-bold"></span></h3>
            <pre id="random-blind-recite-current-line-display" class="hidden text-base text-gray-700 whitespace-pre-wrap font-sans p-2 bg-gray-100 rounded-lg w-full mb-4 text-center"></pre>
            <textarea id="random-blind-recite-input-text" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 font-sans resize-none text-base shadow-sm" rows="3" placeholder="Type the line here..."></textarea>
            <p id="random-blind-recite-feedback" class="text-lg font-semibold mb-4"></p>
            <div class="flex flex-wrap justify-center gap-4">
                <button id="random-blind-recite-next-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75">
                    Next Line
                </button>
                <button id="random-blind-recite-skip-button" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-75">
                    Skip
                </button>
            </div>
            <p id="random-blind-recite-summary" class="text-lg font-bold mt-4"></p>
            <button id="random-blind-recite-reset-button" class="hidden mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                Reset Random Recite
            </button>
        </div>

    </div>

    <script>
        // --- State Variables (simulated React state) ---
        let selectedItem = null;
        let message = '';
        let isLoading = false;
        let showCopySections = false;
        let copyInputText = '';
        let copyButtonText = 'Correct Text';
        let showReciteSection = false;
        let reciteInputText = '';
        let reciteButtonText = 'Recite Text';
        let showBlindReciteSection = false;
        let currentReciteLineIndex = 0;
        let reciteExpectedLines = [];
        let reciteExpectedNormalizedLines = [];
        let blindReciteFeedback = '';
        let blindReciteSummary = '';
        let allBlindReciteLinesCorrect = true;
        let showRandomBlindReciteSection = false; // New state
        let randomBlindReciteItem = null; // New state
        let randomBlindReciteInputText = ''; // New state
        let randomBlindReciteFeedback = ''; // New state
        let randomBlindReciteExpectedLines = []; // New state for line-by-line
        let randomBlindReciteExpectedNormalizedLines = []; // New state for line-by-line
        let currentRandomBlindReciteLineIndex = 0; // New state for line-by-line tracking
        let allRandomBlindReciteLinesCorrect = true; // New state for overall correctness
        let activeButton = null; // 'view', 'copy', 'recite', 'blindRecite', 'randomBlindRecite', or null

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const mainHeading = document.getElementById('main-heading'); // Reference to the main heading
        const menuCardsGrid = document.getElementById('menu-cards-grid');
        const detailView = document.getElementById('detail-view');
        const backButton = document.getElementById('back-button');
        const viewButton = document.getElementById('view-button');
        const copyButton = document.getElementById('copy-button');
        const reciteButton = document.getElementById('recite-button');
        const blindReciteButton = document.getElementById('blind-recite-button');
        const randomBlindReciteButtonContainer = document.getElementById('random-blind-recite-button-container'); // Container for the random button
        const randomBlindReciteButton = document.getElementById('random-blind-recite-button'); // New button
        const messageDisplay = document.getElementById('message-display');
        const copySections = document.getElementById('copy-sections');
        const copyViewContent = document.getElementById('copy-view-content');
        const copyInputTextarea = document.getElementById('copy-input-text');
        const copyTypedButton = document.getElementById('copy-typed-button');
        const reciteSection = document.getElementById('recite-section');
        const reciteInputTextarea = document.getElementById('recite-input-text');
        const reciteTypedButton = document.getElementById('recite-typed-button');
        const blindReciteSection = document.getElementById('blind-recite-section');
        const blindReciteHeading = document.getElementById('blind-recite-heading');
        const blindReciteCurrentLineDisplay = document.getElementById('blind-recite-current-line');
        const blindReciteInputTextarea = document.getElementById('blind-recite-input-text');
        const blindReciteFeedbackDisplay = document.getElementById('blind-recite-feedback');
        const blindReciteNextButton = document.getElementById('blind-recite-next-button');
        const blindReciteSummaryDisplay = document.getElementById('blind-recite-summary');
        const blindReciteResetButton = document.getElementById('blind-recite-reset-button');

        const randomBlindReciteSection = document.getElementById('random-blind-recite-section');
        const randomBlindReciteHeading = document.getElementById('random-blind-recite-heading'); // New reference for heading
        const randomBlindReciteItemName = document.getElementById('random-blind-recite-item-name');
        const randomBlindReciteCurrentLineDisplay = document.getElementById('random-blind-recite-current-line-display'); // New line display for random
        const randomBlindReciteInputTextarea = document.getElementById('random-blind-recite-input-text');
        const randomBlindReciteFeedbackDisplay = document.getElementById('random-blind-recite-feedback');
        const randomBlindReciteNextButton = document.getElementById('random-blind-recite-next-button'); // Renamed from check
        const randomBlindReciteSkipButton = document.getElementById('random-blind-recite-skip-button'); // New skip button
        const randomBlindReciteSummaryDisplay = document.getElementById('random-blind-recite-summary'); // New summary for random
        const randomBlindReciteResetButton = document.getElementById('random-blind-recite-reset-button'); // New reset for random


        // --- Data: Menu Items Descriptions ---
        const menuItemsData = {
            "Big Mac": `
Crown
    10:1
    Pickles - 2
    Shredded Lettuce
    Big Mac Sauce
Club
    10:1
    Cheese
    Shredded Lettuce
    Big Mac Sauce
Heel
            `,
            "Double Big Mac": `
Crown
    10:1 - 2
    Pickles - 2
    Shredded Lettuce
    Big Mac Sauce
Club
    10:1 - 2
    Cheese
    Lettuce
    Big Mac Sauce
Heel
            `,
            "Quarter Pounder": `
Crown
    Mustard
    Ketchup
    Onions - 8-12
    Pickles - 2
    Cheese
    4:1
    Cheese
Heel
            `,
            "Double Quarter Pounder": `
Crown
    Mustard
    Ketchup
    Onions - 8-12
    Pickles - 2
    Cheese
    4:1
    Cheese
    4:1
    Cheese
Heel
            `,
            "BBQ Bacon Angus": `
Crown
    House Grill Sauce
    Aussie Cheese
    Rasher Bacon - 2
    3:1
    Aussie Cheese
    Red Onions - 8-12
    McChicken Sauce
Heel
            `,
            "Classic Angus": `
Crown
    Mustard
    McChicken Sauce
    Red Onions - 8-12
    Pickles - 2
    Shredded Lettuce
    Tomato - 2
    Cheese
    3:1
    Cheese
Heel
            `,
            "Hamburger": `
Crown
    Mustard
    Ketchup
    Pickle
    10:1
Heel
            `,
            "Cheeseburger": `
Crown
    Mustard
    Ketchup
    Pickle
    Cheese
    10:1
Heel
            `,
            "Double Cheeseburger": `
Crown
    Mustard
    Ketchup
    Pickles - 2
    Cheese
    10:1
    Cheese
    10:1
Heel
            `,
            "Triple Cheeseburger": `
Crown
    Mustard
    Ketchup
    Pickles - 2
    Cheese
    10:1
    Cheese
    10:1
    Cheese
    10:1
Heel
            `,
            "McCrispy": `
Crown
    McCrispy Sauce
    Shredded Lettuce
    McCrispy
Heel
            `,
            "McCrispy Deluxe": `
Crown
    McCrispy Sauce
    Shredded Lettuce
    Tomato Slice
    Aussie Cheese
    McCrispy
Heel
            `,
            "McSpicy": `
Crown
    McChicken Sauce
    Shredded Lettuce
    McSpicy
Heel
            `,
            "Chicken n Cheese": `
Crown
    McChicken Sauce
    1/2 Cheese
    Chicken
Heel
            `,
            "Filet o Fish": `
Steamed Crown
    Tar Tar Sauce
    Filet
    1/2 Cheese
Steamed Heel
            `,
            "Classic Chicken Wrap": `
Tortilla 10”
    McCrispy
    Lettuce
    Tomato - 2
    1/2 McCrispy or 1/2 Grilled
            `,
            "Spicy Chicken Wrap": `
Tortilla 10”
    McChicken
    Shredded Lettuce
    Tomato - 2
    1/2 McSpicy
            `,
            "Chicken Snack Wrap": `
Tortilla - 8”
    McChicken Sauce Shredded Lettuce
    1/2 McCrispy or 1/2 Grilled
            `
        };

        // --- Helper Functions ---

        // Returns an array of lines from the description, preserving indentation for non-heading lines
        function getDetailedViewLines(item) {
            const fullText = menuItemsData[item] || `Details for: ${item}.`;
            return fullText.split('\n')
                           .filter(line => line.trim().length > 0) // Remove truly empty lines
                           .map(line => {
                               const trimmedLine = line.trim();
                               // Check if it's a main heading (Crown, Club, Heel, etc.)
                               if (trimmedLine.toLowerCase() === 'crown' ||
                                   trimmedLine.toLowerCase() === 'club' ||
                                   trimmedLine.toLowerCase() === 'heel' ||
                                   trimmedLine.toLowerCase() === 'steamed crown' ||
                                   trimmedLine.toLowerCase() === 'steamed heel' ||
                                   trimmedLine.toLowerCase() === 'tortilla 10”' ||
                                   trimmedLine.toLowerCase() === 'tortilla - 8”'
                               ) {
                                   return trimmedLine; // Keep these unindented
                               } else {
                                   return line; // Keep original leading spaces for other lines
                               }
                           });
        }

        // Normalizes a single line or full text for case-insensitive and whitespace-lenient comparison
        function normalizeTextForComparison(text) {
            return text.split('\n')
                       .map(line => line.trim())
                       .filter(line => line.length > 0)
                       .join(' ')
                       .replace(/\s+/g, ' ')
                       .toLowerCase()
                       .trim();
        }

        // --- Render Functions (to update UI based on state) ---

        function renderApp() {
            // Update main heading text based on selectedItem
            if (selectedItem) {
                mainHeading.textContent = selectedItem;
                mainHeading.classList.remove('mb-10'); // Adjust margin for selected item view
                mainHeading.classList.add('mb-8', 'mt-12'); // Add top margin for back button offset
            } else {
                mainHeading.textContent = 'Please Select one of the Menu Items:';
                mainHeading.classList.remove('mb-8', 'mt-12');
                mainHeading.classList.add('mb-10');
            }

            // Hide/show main views
            if (selectedItem) {
                menuCardsGrid.classList.add('hidden');
                randomBlindReciteButtonContainer.classList.add('hidden'); // Hide random button container on detail view
                detailView.classList.remove('hidden');
            } else {
                menuCardsGrid.classList.remove('hidden');
                randomBlindReciteButtonContainer.classList.remove('hidden'); // Show random button container on main view
                detailView.classList.add('hidden');
            }

            // Update message display
            if (message) {
                messageDisplay.textContent = message;
                messageDisplay.classList.remove('hidden');
                messageDisplay.classList.add('animate-fade-in');
            } else {
                messageDisplay.classList.add('hidden');
                messageDisplay.classList.remove('animate-fade-in');
            }

            // Update loading state
            if (isLoading) {
                messageDisplay.textContent = 'Loading...';
                messageDisplay.classList.remove('hidden');
                messageDisplay.classList.add('animate-pulse');
            } else {
                messageDisplay.classList.remove('animate-pulse');
            }

            // Update Copy sections visibility
            if (showCopySections) {
                copySections.classList.remove('hidden');
                copyTypedButton.classList.remove('hidden');
                copyViewContent.textContent = getDetailedViewLines(selectedItem).join('\n');
                copyInputTextarea.value = copyInputText;
                copyTypedButton.textContent = copyButtonText;
            } else {
                copySections.classList.add('hidden');
                copyTypedButton.classList.add('hidden');
            }

            // Update Recite section visibility
            if (showReciteSection) {
                reciteSection.classList.remove('hidden');
                reciteInputTextarea.value = reciteInputText;
                reciteTypedButton.textContent = reciteButtonText;
            } else {
                reciteSection.classList.add('hidden');
            }

            // Update Blind Recite section visibility
            if (showBlindReciteSection) {
                blindReciteSection.classList.remove('hidden');
                if (currentReciteLineIndex < reciteExpectedLines.length) {
                    blindReciteCurrentLineDisplay.classList.add('hidden');
                    blindReciteHeading.textContent = `Your Turn (Line ${currentReciteLineIndex + 1} of ${reciteExpectedLines.length}):`;
                    blindReciteInputTextarea.value = '';
                    blindReciteNextButton.classList.remove('hidden');
                    blindReciteSummaryDisplay.classList.add('hidden');
                    blindReciteResetButton.classList.add('hidden');
                    blindReciteInputTextarea.focus();
                } else {
                    blindReciteCurrentLineDisplay.classList.add('hidden');
                    blindReciteHeading.textContent = 'Recitation Complete!';
                    blindReciteInputTextarea.value = '';
                    blindReciteInputTextarea.disabled = true;
                    blindReciteNextButton.classList.add('hidden');
                    blindReciteSummaryDisplay.classList.remove('hidden');
                    blindReciteSummaryDisplay.textContent = allBlindReciteLinesCorrect ? 'All lines were correct!' : 'Some lines were wrong.';
                    blindReciteSummaryDisplay.classList.remove('text-green-600', 'text-red-600');
                    blindReciteSummaryDisplay.classList.add(allBlindReciteLinesCorrect ? 'text-green-600' : 'text-red-600');
                    blindReciteResetButton.classList.remove('hidden');
                }
                blindReciteFeedbackDisplay.textContent = blindReciteFeedback;
                blindReciteFeedbackDisplay.classList.remove('text-green-600', 'text-red-600');
                if (blindReciteFeedback === 'Correct!') {
                    blindReciteFeedbackDisplay.classList.add('text-green-600');
                } else if (blindReciteFeedback === 'Wrong!') {
                    blindReciteFeedbackDisplay.classList.add('text-red-600');
                }
            } else {
                blindReciteSection.classList.add('hidden');
            }

            // Update Random Blind Recite section visibility (now line-by-line)
            if (showRandomBlindReciteSection) {
                randomBlindReciteSection.classList.remove('hidden');
                if (currentRandomBlindReciteLineIndex < randomBlindReciteExpectedLines.length) {
                    randomBlindReciteCurrentLineDisplay.classList.add('hidden'); // Keep line content hidden
                    randomBlindReciteHeading.textContent = `Recite: ${randomBlindReciteItem} (Line ${currentRandomBlindReciteLineIndex + 1} of ${randomBlindReciteExpectedLines.length})`;
                    randomBlindReciteInputTextarea.value = randomBlindReciteInputText; // Set value from state
                    randomBlindReciteNextButton.classList.remove('hidden');
                    randomBlindReciteSummaryDisplay.classList.add('hidden');
                    randomBlindReciteResetButton.classList.add('hidden');
                    randomBlindReciteInputTextarea.focus(); // Focus input for typing
                    randomBlindReciteInputTextarea.disabled = false; // Ensure it's enabled
                } else {
                    // End of recitation
                    randomBlindReciteCurrentLineDisplay.classList.add('hidden');
                    randomBlindReciteHeading.textContent = `Recitation Complete for ${randomBlindReciteItem}!`;
                    randomBlindReciteInputTextarea.value = '';
                    randomBlindReciteInputTextarea.disabled = true;
                    randomBlindReciteNextButton.classList.add('hidden');
                    randomBlindReciteSummaryDisplay.classList.remove('hidden');
                    randomBlindReciteSummaryDisplay.textContent = allRandomBlindReciteLinesCorrect ? 'All lines were correct!' : 'Some lines were wrong.';
                    randomBlindReciteSummaryDisplay.classList.remove('text-green-600', 'text-red-600');
                    randomBlindReciteSummaryDisplay.classList.add(allRandomBlindReciteLinesCorrect ? 'text-green-600' : 'text-red-600');
                    randomBlindReciteResetButton.classList.remove('hidden');
                }
                randomBlindReciteFeedbackDisplay.textContent = randomBlindReciteFeedback;
                randomBlindReciteFeedbackDisplay.classList.remove('text-green-600', 'text-red-600');
                if (randomBlindReciteFeedback === 'Correct!') {
                    randomBlindReciteFeedbackDisplay.classList.add('text-green-600');
                } else if (randomBlindReciteFeedback === 'Wrong!') {
                    randomBlindReciteFeedbackDisplay.classList.add('text-red-600');
                }
            } else {
                randomBlindReciteSection.classList.add('hidden');
            }


            // Update active button styling
            [viewButton, copyButton, reciteButton, blindReciteButton, randomBlindReciteButton].forEach(btn => {
                btn.classList.remove('ring-4', 'ring-green-300', 'ring-purple-300', 'ring-orange-300', 'ring-blue-300', 'ring-indigo-300', 'ring-offset-2', 'ring-offset-white');
                // Revert to original styling for non-active buttons
                if (btn.id === 'view-button') btn.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75';
                if (btn.id === 'copy-button') btn.className = 'bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75';
                if (btn.id === 'recite-button') btn.className = 'bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-75';
                if (btn.id === 'blind-recite-button') btn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75';
                if (btn.id === 'random-blind-recite-button') btn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75';
            });

            if (activeButton === 'view') {
                viewButton.classList.add('ring-4', 'ring-green-300', 'ring-offset-2', 'ring-offset-white');
            } else if (activeButton === 'copy') {
                copyButton.classList.add('ring-4', 'ring-purple-300', 'ring-offset-2', 'ring-offset-white');
            } else if (activeButton === 'recite') {
                reciteButton.classList.add('ring-4', 'ring-orange-300', 'ring-offset-2', 'ring-offset-white');
            } else if (activeButton === 'blindRecite') {
                blindReciteButton.classList.add('ring-4', 'ring-blue-300', 'ring-offset-2', 'ring-offset-white');
            } else if (activeButton === 'randomBlindRecite') {
                randomBlindReciteButton.classList.add('ring-4', 'ring-indigo-300', 'ring-offset-2', 'ring-offset-white');
            }
        }

        // --- Event Handlers ---

        function handleCardClick(item) {
            selectedItem = item;
            message = '';
            isLoading = false;
            showCopySections = false;
            copyButtonText = 'Correct Text';
            showReciteSection = false;
            reciteButtonText = 'Recite Text';
            showBlindReciteSection = false;
            blindReciteFeedback = '';
            blindReciteSummary = '';
            showRandomBlindReciteSection = false; // Reset new mode
            randomBlindReciteFeedback = '';
            activeButton = null;
            renderApp();
        }

        function handleBackToMenu() {
            selectedItem = null;
            message = '';
            isLoading = false;
            showCopySections = false;
            copyButtonText = 'Correct Text';
            showReciteSection = false;
            reciteButtonText = 'Recite Text';
            showBlindReciteSection = false;
            blindReciteFeedback = '';
            blindReciteSummary = '';
            showRandomBlindReciteSection = false; // Reset new mode
            randomBlindReciteFeedback = '';
            activeButton = null;
            renderApp();
        }

        function handleViewClick() {
            isLoading = true;
            message = '';
            renderApp();
            setTimeout(() => {
                const viewText = getDetailedViewLines(selectedItem).join('\n');
                message = viewText.trim();
                isLoading = false;
                showCopySections = false;
                showReciteSection = false;
                showBlindReciteSection = false;
                showRandomBlindReciteSection = false; // Hide new mode
                activeButton = 'view';
                renderApp();
            }, 100);
        }

        function handleCopyClick() {
            showCopySections = true;
            copyInputText = '';
            message = '';
            copyButtonText = 'Correct Text';
            showReciteSection = false;
            showBlindReciteSection = false;
            showRandomBlindReciteSection = false; // Hide new mode
            activeButton = 'copy';
            renderApp();
        }

        function handleCopyTypedText() {
            const expectedText = normalizeTextForComparison(getDetailedViewLines(selectedItem).join('\n'));
            const enteredText = normalizeTextForComparison(copyInputText);

            if (enteredText === expectedText) {
                const el = document.createElement('textarea');
                el.value = copyInputText;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    copyButtonText = 'Correct!';
                    copyInputText = '';
                    message = '';
                } catch (err) {
                    message = 'Failed to copy to clipboard.';
                    copyButtonText = 'Wrong!';
                }
                document.body.removeChild(el);
            } else {
                copyButtonText = 'Wrong!';
                message = '';
            }
            renderApp();
        }

        function handleCopyInput(e) {
            copyInputText = e.target.value;
            copyButtonText = 'Correct Text';
            renderApp();
        }

        function handleReciteClick() {
            showReciteSection = true;
            reciteInputText = '';
            message = '';
            reciteButtonText = 'Recite Text';
            showCopySections = false;
            showBlindReciteSection = false;
            showRandomBlindReciteSection = false; // Hide new mode
            activeButton = 'recite';
            renderApp();
        }

        function handleReciteInput(e) {
            reciteInputText = e.target.value;
            reciteButtonText = 'Recite Text';
            renderApp();
        }

        function handleReciteTypedText() {
            const expectedText = normalizeTextForComparison(getDetailedViewLines(selectedItem).join('\n'));
            const enteredText = normalizeTextForComparison(reciteInputText);

            if (enteredText === expectedText) {
                reciteButtonText = 'Correct!';
                reciteInputText = '';
                message = '';
            } else {
                reciteButtonText = 'Wrong!';
                message = '';
            }
            renderApp();
        }

        // --- Blind Recite Functions ---
        function handleBlindReciteClick() {
            showBlindReciteSection = true;
            currentReciteLineIndex = 0;
            reciteExpectedLines = getDetailedViewLines(selectedItem);
            reciteExpectedNormalizedLines = reciteExpectedLines.map(line => normalizeTextForComparison(line));
            blindReciteFeedback = '';
            blindReciteSummary = '';
            allBlindReciteLinesCorrect = true;
            blindReciteInputTextarea.disabled = false;
            message = '';
            showCopySections = false;
            showReciteSection = false;
            showRandomBlindReciteSection = false; // Hide new mode
            activeButton = 'blindRecite';
            renderApp();
        }

        function handleNextBlindReciteLine() {
            if (currentReciteLineIndex < reciteExpectedLines.length) {
                const expectedLine = reciteExpectedNormalizedLines[currentReciteLineIndex];
                const enteredLine = normalizeTextForComparison(blindReciteInputTextarea.value);

                if (enteredLine === expectedLine) {
                    blindReciteFeedback = 'Correct!';
                } else {
                    blindReciteFeedback = 'Wrong!';
                    allBlindReciteLinesCorrect = false;
                }
                currentReciteLineIndex++;
                renderApp();
            }
        }

        function handleBlindReciteInputKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleNextBlindReciteLine();
            }
        }

        function handleResetBlindRecite() {
            currentReciteLineIndex = 0;
            blindReciteFeedback = '';
            blindReciteSummary = '';
            allBlindReciteLinesCorrect = true;
            blindReciteInputTextarea.disabled = false;
            renderApp();
        }

        // --- Random Blind Recite Functions ---
        function startNewRandomBlindRecite() {
            const itemNames = Object.keys(menuItemsData);
            const randomIndex = Math.floor(Math.random() * itemNames.length);
            randomBlindReciteItem = itemNames[randomIndex];

            randomBlindReciteExpectedLines = getDetailedViewLines(randomBlindReciteItem); // Get lines for the random item
            randomBlindReciteExpectedNormalizedLines = randomBlindReciteExpectedLines.map(line => normalizeTextForComparison(line));
            currentRandomBlindReciteLineIndex = 0; // Start from the first line
            allRandomBlindReciteLinesCorrect = true; // Reset overall correctness

            randomBlindReciteInputText = ''; // Clear input text
            randomBlindReciteFeedback = ''; // Clear feedback
            randomBlindReciteInputTextarea.disabled = false; // Ensure input is enabled
            randomBlindReciteItemName.textContent = randomBlindReciteItem; // Update item name in heading
            randomBlindReciteInputTextarea.focus(); // Focus input for typing
        }

        function handleRandomBlindReciteClick() {
            showRandomBlindReciteSection = true;
            message = '';
            showCopySections = false;
            showReciteSection = false;
            showBlindReciteSection = false;
            activeButton = 'randomBlindRecite';
            selectedItem = null; // Ensure selectedItem is null for the overall heading to be "Please Select..."
            startNewRandomBlindRecite(); // Start with a new random item
            renderApp();
        }

        function handleNextRandomBlindReciteLine() { // Renamed from handleRandomBlindReciteCheck
            if (currentRandomBlindReciteLineIndex < randomBlindReciteExpectedLines.length) {
                const expectedLine = randomBlindReciteExpectedNormalizedLines[currentRandomBlindReciteLineIndex];
                const enteredLine = normalizeTextForComparison(randomBlindReciteInputTextarea.value);

                if (enteredLine === expectedLine) {
                    randomBlindReciteFeedback = 'Correct!';
                } else {
                    randomBlindReciteFeedback = 'Wrong!';
                    allRandomBlindReciteLinesCorrect = false;
                }
                currentRandomBlindReciteLineIndex++;
                randomBlindReciteInputText = ''; // Clear input for the next line
                renderApp(); // Render to show feedback and next line
            }

            // If all lines are done, check overall result
            if (currentRandomBlindReciteLineIndex >= randomBlindReciteExpectedLines.length) {
                if (!allRandomBlindReciteLinesCorrect) {
                    // If any line was wrong, switch to copy mode for the item
                    setTimeout(() => {
                        selectedItem = randomBlindReciteItem; // Set the item they got wrong
                        handleCopyClick(); // Switch to copy mode for this item
                        randomBlindReciteFeedback = ''; // Clear feedback
                        showRandomBlindReciteSection = false; // Hide random recite section
                        renderApp();
                    }, 1000); // Short delay before switching mode
                } else {
                    // If all lines correct, start a new random item
                    setTimeout(() => {
                        startNewRandomBlindRecite();
                        renderApp(); // Re-render to show new item
                    }, 500); // Short delay for feedback visibility
                }
            }
        }

        function handleRandomBlindReciteInput(e) {
            randomBlindReciteInputText = e.target.value;
            randomBlindReciteFeedback = ''; // Clear feedback when user starts typing
            renderApp();
        }

        function handleRandomBlindReciteInputKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent new line in textarea
                handleNextRandomBlindReciteLine();
            }
        }

        function handleRandomBlindReciteSkip() { // New skip function
            startNewRandomBlindRecite(); // Get a new random item
            randomBlindReciteFeedback = ''; // Clear any feedback
            renderApp();
        }

        function handleRandomBlindReciteReset() { // New reset function for random mode
            startNewRandomBlindRecite();
            randomBlindReciteFeedback = '';
            randomBlindReciteInputTextarea.disabled = false;
            renderApp();
        }


        // --- Initial Render and Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Render menu cards
            const menuItems = Object.keys(menuItemsData);
            menuItems.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:shadow-xl transform hover:-translate-y-2 transition duration-300 ease-in-out border border-gray-100 hover:border-blue-300 group";
                card.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-700 mb-2 group-hover:text-blue-600 transition-colors duration-300">${item}</h2>
                    <p class="text-sm text-gray-500 group-hover:text-blue-500 transition-colors duration-300">Select to view</p>
                `;
                card.addEventListener('click', () => handleCardClick(item));
                menuCardsGrid.appendChild(card);
            });

            // Add event listeners for detail view buttons
            backButton.addEventListener('click', handleBackToMenu);
            viewButton.addEventListener('click', handleViewClick);
            copyButton.addEventListener('click', handleCopyClick);
            copyTypedButton.addEventListener('click', handleCopyTypedText);
            copyInputTextarea.addEventListener('input', handleCopyInput);
            reciteButton.addEventListener('click', handleReciteClick);
            reciteTypedButton.addEventListener('click', handleReciteTypedText);
            reciteInputTextarea.addEventListener('input', handleReciteInput);
            blindReciteButton.addEventListener('click', handleBlindReciteClick);
            blindReciteNextButton.addEventListener('click', handleNextBlindReciteLine);
            blindReciteInputTextarea.addEventListener('keydown', handleBlindReciteInputKeydown);
            blindReciteResetButton.addEventListener('click', handleResetBlindRecite);

            // New random blind recite event listeners
            randomBlindReciteButton.addEventListener('click', handleRandomBlindReciteClick);
            randomBlindReciteNextButton.addEventListener('click', handleNextRandomBlindReciteLine); // Renamed from check button
            randomBlindReciteInputTextarea.addEventListener('input', handleRandomBlindReciteInput);
            randomBlindReciteInputTextarea.addEventListener('keydown', handleRandomBlindReciteInputKeydown);
            randomBlindReciteSkipButton.addEventListener('click', handleRandomBlindReciteSkip); // New skip button event listener
            randomBlindReciteResetButton.addEventListener('click', handleRandomBlindReciteReset); // New reset button event listener


            // Initial render
            renderApp();
        });
    </script>
</body>
</html>
